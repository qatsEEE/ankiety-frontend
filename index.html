<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>System Ankiet - Głosuj!</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.14/signalr.min.js"></script>
    <style>
        body {
            background: #f7fafc;
        }
        .card {
            margin-top: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,.06);
        }
        .option-btn {
            margin-bottom: 10px;
            width: 100%;
            font-size: 1.1rem;
        }
        .progress {
            height: 1.5rem;
            margin-bottom: 10px;
        }
        .vote-count {
            font-size: 1rem;
            font-weight: bold;
        }
        .fade-in {
            animation: fadeIn .6s;
        }
        @keyframes fadeIn {
            from { opacity: 0;}
            to   { opacity: 1;}
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">
            <div class="card fade-in">
                <div class="card-body" id="pollContainer">
                    <div class="text-center">
                        <div class="spinner-border" role="status"></div>
                        <div>Ładowanie ankiety...</div>
                    </div>
                </div>
            </div>
            <div id="toast" class="toast align-items-center text-white bg-success border-0 position-fixed bottom-0 end-0 m-4" style="z-index:9999;" role="alert">
                <div class="d-flex">
                    <div class="toast-body"></div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="hideToast()"></button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const pollId = 1; // <- zmień na dynamiczne ID jeśli potrzeba
let pollData = null;

function showToast(msg, isError = false) {
    const toast = document.getElementById('toast');
    toast.classList.toggle('bg-success', !isError);
    toast.classList.toggle('bg-danger', isError);
    toast.querySelector('.toast-body').textContent = msg;
    toast.style.display = 'block';
    setTimeout(hideToast, 3500);
}
function hideToast() {
    document.getElementById('toast').style.display = 'none';
}

// Pobierz ankietę z backendu
async function fetchPoll() {
    document.getElementById('pollContainer').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status"></div>
            <div>Ładowanie ankiety...</div>
        </div>
    `;
    const res = await fetch(`/api/polls/${pollId}`);
    if (!res.ok) {
        document.getElementById('pollContainer').innerHTML = `<div class="text-danger p-3">Nie znaleziono ankiety!</div>`;
        return;
    }
    pollData = await res.json();
    renderPoll();
}

// Wyświetl ankietę
function renderPoll() {
    const pollDiv = document.getElementById('pollContainer');
    let totalVotes = pollData.options.reduce((a, b) => a + b.votes, 0);
    pollDiv.innerHTML = `
        <h4 class="card-title text-center mb-3">${pollData.question}</h4>
        <div id="optionsList">
            ${pollData.options.map(option => `
                <button class="btn btn-outline-primary option-btn" onclick="vote(${option.id})" id="option-btn-${option.id}">
                    <span>${option.text}</span>
                </button>
                <div class="progress">
                    <div class="progress-bar bg-info" role="progressbar" style="width: ${totalVotes ? option.votes/totalVotes*100 : 0}%" id="bar-${option.id}">
                        ${totalVotes ? Math.round(option.votes/totalVotes*100) : 0}%
                    </div>
                </div>
                <div class="vote-count text-end" id="votes-${option.id}">${option.votes} głosów</div>
            `).join('')}
        </div>
        <div class="text-center mt-3 text-secondary">Oddano głosów: <span id="totalVotes">${totalVotes}</span></div>
    `;
}

// Oddaj głos
async function vote(optionId) {
    // Zablokuj przyciski
    pollData.options.forEach(opt => document.getElementById('option-btn-' + opt.id).disabled = true);
    const res = await fetch('/api/polls/vote', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({optionId})
    });
    if (res.ok) {
        showToast('Twój głos został oddany!');
    } else {
        showToast('Błąd podczas głosowania!', true);
    }
    // Po głosie - nie odświeżamy, czekamy na SignalR
}

// SignalR - nasłuchuj na nowe głosy
async function setupSignalR() {
    // Pobierz token połączenia
    const res = await fetch('/api/negotiate', { method: 'POST' });
    if (!res.ok) {
        console.error('Nie można pobrać tokenu SignalR');
        return;
    }
    const { url, accessToken } = await res.json();
    const connection = new signalR.HubConnectionBuilder()
        .withUrl(url, { accessTokenFactory: () => accessToken })
        .withAutomaticReconnect()
        .build();

    connection.on('newVote', (pollIdR, optionId, votes) => {
        if (pollData && pollData.id === pollIdR) {
            // Znajdź opcję i zaktualizuj liczbę głosów
            const option = pollData.options.find(o => o.id === optionId);
            if (option) {
                option.votes = votes;
                // Przelicz sumę głosów
                const totalVotes = pollData.options.reduce((a, b) => a + b.votes, 0);
                document.getElementById('votes-' + optionId).textContent = votes + ' głosów';
                document.getElementById('totalVotes').textContent = totalVotes;
                // Procentowe słupki
                pollData.options.forEach(opt => {
                    const bar = document.getElementById('bar-' + opt.id);
                    const percent = totalVotes ? Math.round(opt.votes/totalVotes*100) : 0;
                    bar.style.width = percent + '%';
                    bar.textContent = percent + '%';
                });
            }
        }
    });

    connection.start()
        .then(() => console.log('SignalR connected!'))
        .catch(err => console.error('SignalR error:', err));
}

fetchPoll();
setupSignalR();
</script>
</body>
</html>
